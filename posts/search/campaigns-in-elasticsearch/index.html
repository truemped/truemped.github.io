<!doctype html><html lang=en><head><title>Campaigns in Elasticsearch · all things considered...</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Daniel Truemper"><meta name=description content="In e-commerce search enabling dynamic prices or campaigns requires some attributes to be more volatile than others. A discount on Black Friday that is should only be valid between 7 PM and midnight. The flags that promote the discount. The teasers on product listings showing what products will have a discount, before the discount is in effect. Products that are only discounted for a certain customer group.
Traditionally this is solved by updating the documents in the search index."><meta name=keywords content="blog,developer,personal,engineering management,leadership"><meta name=twitter:card content="summary"><meta name=twitter:title content="Campaigns in Elasticsearch"><meta name=twitter:description content="In e-commerce search enabling dynamic prices or campaigns requires some attributes to be more volatile than others. A discount on Black Friday that is should only be valid between 7 PM and midnight. The flags that promote the discount. The teasers on product listings showing what products will have a discount, before the discount is in effect. Products that are only discounted for a certain customer group.
Traditionally this is solved by updating the documents in the search index."><meta property="og:title" content="Campaigns in Elasticsearch"><meta property="og:description" content="In e-commerce search enabling dynamic prices or campaigns requires some attributes to be more volatile than others. A discount on Black Friday that is should only be valid between 7 PM and midnight. The flags that promote the discount. The teasers on product listings showing what products will have a discount, before the discount is in effect. Products that are only discounted for a certain customer group.
Traditionally this is solved by updating the documents in the search index."><meta property="og:type" content="article"><meta property="og:url" content="https://truemped.github.io/posts/search/campaigns-in-elasticsearch/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-13T17:00:00+02:00"><meta property="article:modified_time" content="2020-04-13T17:00:00+02:00"><link rel=canonical href=https://truemped.github.io/posts/search/campaigns-in-elasticsearch/><link rel=preload href="https://truemped.github.io/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://truemped.github.io/css/coder.min.5adbe72fc41dcfb852215b84695288939b6b606db73238bd3ee936469572fc9c.css integrity="sha256-WtvnL8Qdz7hSIVuEaVKIk5trYG23Mji9Puk2RpVy/Jw=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://truemped.github.io/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://truemped.github.io/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://truemped.github.io/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://truemped.github.io/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://truemped.github.io/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://truemped.github.io/images/apple-touch-icon.png><link rel=manifest href=https://truemped.github.io/site.webmanifest><link rel=mask-icon href=https://truemped.github.io/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://truemped.github.io/>all things considered...</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://truemped.github.io/about/>About Me</a></li><li class=navigation-item><a class=navigation-link href=https://truemped.github.io/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://truemped.github.io/ideas-concepts/>Ideas & Concepts</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://truemped.github.io/posts/search/campaigns-in-elasticsearch/>Campaigns in Elasticsearch</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2020-04-13T17:00:00+02:00>April 13, 2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
9-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://truemped.github.io/tags/elasticsearch/>elasticsearch</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://truemped.github.io/tags/howto/>howto</a></span></div></div></header><div class=post-content><p>In e-commerce search enabling dynamic prices or campaigns requires some
attributes to be more volatile than others. A discount on Black Friday that is
should only be valid between 7 PM and midnight. The flags that promote the
discount. The teasers on product listings showing what products will have a
discount, before the discount is in effect. Products that are only discounted
for a certain customer group.</p><p>Traditionally this is solved by updating the documents in the search index.
Around the time new information has to go live, all affected documents are
updated. There are at least two huge problems with this approach. The first one
is that updating a large portion of the index takes time. During large sales
events this easily means updating the whole index. Sometimes more than once if
your intake pipelines contain loops, e.g. This creates a huge load onto the
system which at this point can already have a lot of users looking for the deals
to become active. User facing errors are the last thing you would tolerate at
that time.</p><p>The second problem is the missing of an exact timing for the new information to
go live. The only possibility to have cross-document transactions in Lucene is
by not committing the new changes. Only when all changes have been processed you
run a <code>commit</code> once to make the new information visible to users. In an event
sourced system, the exact time at which a certain update is finished, may be
impossible to define. Additionally this operation is potentially heavy as you
might be reloading the whole index. Queries to this index then experience a time
of high latency as all caches need to be filled again.</p><h1 id=modeling-dynamic-information-as-nested-documents>Modeling dynamic information as nested documents
<a class=heading-link href=#modeling-dynamic-information-as-nested-documents><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Another solution to this is to model the data in a way that information becomes
<code>true</code> based on the time of the users request. The idea is quite simple: instead
of updating all documents, the times at which information is valid is encoded in
the documents themselves. Using Elasticsearch&rsquo;s nested documents the relevant
pieces are then extracted at query time. The timelines of when what part of the
information is visible can then be ingested long before and during times of very
low traffic.</p><p>I will describe the idea using a toy example. Two <em>products</em> are indexed and
they both have a list of <code>prices</code> as objects. These <em>price objects</em> contain the
price as well as the start and end date. Filtering and aggregating (aka
faceting) are then achieved using nested filters and aggregations.</p><h2 id=index-setup>Index Setup
<a class=heading-link href=#index-setup><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The index mapping describes the list of <code>prices</code> indexed as nested documents:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;mappings&#34;</span>: {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;prices&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;nested&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;price&#34;</span>: {<span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span>},
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;from&#34;</span>:  {<span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;date&#34;</span>},
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;to&#34;</span>:    {<span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;date&#34;</span>}
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Two documents will now be indexed. The first product is discounted between
<em>2020-03-17T18:00:00Z</em> and <em>2020-03-18T23:59:59Z</em>. It&rsquo;s normal price is 15 and
the discounted price is 12.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;prices&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>15</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;from&#34;</span>:  <span style=color:#e6db74>&#34;2020-03-17T00:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;to&#34;</span>:    <span style=color:#e6db74>&#34;2020-03-17T17:59:59Z&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>12</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;from&#34;</span>:  <span style=color:#e6db74>&#34;2020-03-17T18:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;to&#34;</span>:    <span style=color:#e6db74>&#34;2020-03-18T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>15</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;from&#34;</span>:  <span style=color:#e6db74>&#34;2020-03-19T00:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;to&#34;</span>:    <span style=color:#e6db74>&#34;2020-03-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The second product is discounted between <em>2020-03-17T19:00:00Z</em> and
<em>2020-03-18T09:59:59Z</em>. It&rsquo;s normal price is 20 and the discounted price is 10.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;prices&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;from&#34;</span>:  <span style=color:#e6db74>&#34;2020-03-17T00:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;to&#34;</span>:    <span style=color:#e6db74>&#34;2020-03-17T17:59:59Z&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;from&#34;</span>:  <span style=color:#e6db74>&#34;2020-03-17T19:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;to&#34;</span>:    <span style=color:#e6db74>&#34;2020-03-18T09:59:59Z&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;from&#34;</span>:  <span style=color:#e6db74>&#34;2020-03-19T00:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;to&#34;</span>:    <span style=color:#e6db74>&#34;2020-03-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=constructing-the-price-facet>Constructing the price facet
<a class=heading-link href=#constructing-the-price-facet><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>All examples have a simulated time. In reality one would simply change the time
to something like <em>now/m</em>. This would allow for price changes to take effect
every minute while enabling internal caches in Elasticsearch. In the following
examples, <em>now</em> is explicitly set to a certain point in time.</p><p>The Elasticsearch query to retrieve the correct price contains a boolean filter.
This filter will select the correct <em>price object</em> based on a certain point in
time. The aggregation will then be performed based on those objects. In this
example, <em>now</em> is equal to <em>2020-03-17T13:00:00Z</em>, so before any discount was
given.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;query&#34;</span>: {<span style=color:#f92672>&#34;match_all&#34;</span>: {}},
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;aggs&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;nested_prices&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;nested&#34;</span>: {<span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;prices&#34;</span>},
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;aggs&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;inner&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;filter&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;bool&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;must&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&#34;range&#34;</span>: {<span style=color:#f92672>&#34;prices.from&#34;</span>: {<span style=color:#f92672>&#34;lte&#34;</span>: <span style=color:#e6db74>&#34;2020-03-17T13:00:00Z&#34;</span>}}
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&#34;range&#34;</span>: {<span style=color:#f92672>&#34;prices.to&#34;</span>: {<span style=color:#f92672>&#34;gte&#34;</span>: <span style=color:#e6db74>&#34;2020-03-17T13:00:00Z&#34;</span>}}
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>              ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;aggs&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;prices&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;terms&#34;</span>: {<span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;prices.price&#34;</span>}
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Beginning with line 10 the filter for the currently active price object is
defined. In line 21 a nested aggregation, based on the filtered price objects,
creates the actual computation of the prices.</p><p>The result looks like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>[...]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;aggregations&#34;</span> : {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;nested_prices&#34;</span> : {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;meta&#34;</span> : { },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;inner&#34;</span> : {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;meta&#34;</span> : { },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;prices&#34;</span> : {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;doc_count_error_upper_bound&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;sum_other_doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;buckets&#34;</span> : [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>15</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>In line 6 a <code>doc_count</code> of 6 is defined. This is the number of nested documents
that are in the index. For each of the two <strong>products</strong>, three nested documents
contain the price information at a given point in time. In line 9 the
<code>doc_count</code> is only two, as only two nested documents match the filter criteria.
Beginning on line 13 we see the two prices: 15 and 20.</p><p>Changing <em>now</em> to <em>2020-03-18T09:00:00Z</em> we expect to get the discounted prices
for both documents. Using the query from above but only changing the date
returns the following:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>[...]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;aggregations&#34;</span> : {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;nested_prices&#34;</span> : {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;inner&#34;</span> : {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;prices&#34;</span> : {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;doc_count_error_upper_bound&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;sum_other_doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;buckets&#34;</span> : [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>12</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Beginning in line 11 there are now the correct prices returned: 10 and 12.</p><h2 id=filtering-for-price-ranges>Filtering for price ranges
<a class=heading-link href=#filtering-for-price-ranges><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Based on the information the user has seen, they now want to filter for a
certain price range. For this to work the main <code>query</code> part of the query above
needs to filter for all documents, that contain a price within the range at a
given point in time. Again this is achieved using nested filters. The query from
above needs to change the query part in order to filter for prices between 5 and
11:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;size&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;query&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;bool&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;must&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;nested&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;prices&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;query&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;range&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;prices.price&#34;</span>: {
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&#34;gte&#34;</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&#34;lte&#34;</span>: <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;nested&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;prices&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;query&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;range&#34;</span>: {<span style=color:#f92672>&#34;prices.from&#34;</span>: {<span style=color:#f92672>&#34;lte&#34;</span>: <span style=color:#e6db74>&#34;2020-03-18T09:00:00Z&#34;</span>}}
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;nested&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;prices&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;query&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;range&#34;</span>: {<span style=color:#f92672>&#34;prices.to&#34;</span>: {<span style=color:#f92672>&#34;gte&#34;</span>: <span style=color:#e6db74>&#34;2020-03-18T09:00:00Z&#34;</span>}}
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;aggs&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;nested_prices&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;nested&#34;</span>: {<span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;prices&#34;</span>},
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;aggs&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;inner&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;filter&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;bool&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;must&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&#34;range&#34;</span>: {<span style=color:#f92672>&#34;prices.from&#34;</span>: {<span style=color:#f92672>&#34;lte&#34;</span>: <span style=color:#e6db74>&#34;2020-03-18T09:00:00Z&#34;</span>}}
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&#34;range&#34;</span>: {<span style=color:#f92672>&#34;prices.to&#34;</span>: {<span style=color:#f92672>&#34;gte&#34;</span>: <span style=color:#e6db74>&#34;2020-03-18T09:00:00Z&#34;</span>}}
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>              ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;aggs&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;prices&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;terms&#34;</span>: {<span style=color:#f92672>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;prices.price&#34;</span>}
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This query will return the following result:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;hits&#34;</span> : {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;total&#34;</span> : {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;relation&#34;</span> : <span style=color:#e6db74>&#34;eq&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max_score&#34;</span> : <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;hits&#34;</span> : [ ]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;aggregations&#34;</span> : {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;nested_prices&#34;</span> : {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;inner&#34;</span> : {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;prices&#34;</span> : {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;doc_count_error_upper_bound&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;sum_other_doc_count&#34;</span> : <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;buckets&#34;</span> : [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;key&#34;</span> : <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;doc_count&#34;</span> : <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>In contrast to before only one document matched (line 4). This is also reflected
in the number of nested documents used for the aggregation (line 12). For the
final nested aggregation only one price object is used (line 14). Both, the
filtering for documents with a specific price and the aggregation at a certain
time work.</p><h2 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>This method allows the modeling of dynamic information that changes based on the
time a user issued a query. In the example above only prices were used but other
information like flags or availability can me modeled accordingly.</p><p>I see two drawbacks of this method. In case of quick adjustments to campaign
plans from commercial teams a full re-index is still required. There is just no
way around this. For this to get more efficient, Elasticsearch needs to support
updating doc values alone, without updating the whole document.</p><p>The second critical point is the data modeling and enforcement of constraints.
This method relies on the fact that only one nested document is within the time
range at any given point in time. Two documents, that overlap in their start or
end-date return invalid results, because the same product document is counted
twice. This constraint needs to be enforced at index time. In case were the
price information belongs to another team, this needs to be part of the contract
between the two teams. But this is a whole other story.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2015 -
2023
Daniel Truemper
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=https://truemped.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script data-goatcounter=https://truemped.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>