<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>all things considered: Continuous delivery with automatic failover</title>
    <link rel="canonical" href="http://truemped.github.io/posts/2016-06-07-failover-continuous-deployment.html">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/index.html">all things considered</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/index.html">Home</a></li>
                <li
                ><a href="/archives.html">Archives</a></li>
                
                <li
                >
                <a href="/pages/about.html">About</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">June 7, 2016</div>
        
    </div>
    <h2>Continuous delivery with automatic failover</h2>
</div>
<div>
    
    <p>This post is kicking of a little blog series about my adventures into building a fault tolerant Python based web site. The goals are simple:</p><ul><li>two VMs with automatic failover and floating IP</li><li>shared filesystem</li><li>Debian packages for the Python project</li><li>continuous integration</li><li>continuous delivery</li></ul><p>In addition to this series of blog posts there will be an example Ansible playbook on Github containing all the relevant roles.</p><h3 id="agenda">Agenda</h3><p>The series is divided into 7 posts. With every new post I will update the links here. They are also available under the tag <a href='/devops-series.html'>devops-series</a>.</p><ol><li><a href='/posts/2016-06-07-failover-continuous-deployment.html'>Basics: Debian VM, security and common packages</a></li><li>Corosync, Pacemaker, Floating IP</li><li>Private Networking: TINC</li><li>GlusterFS: shared filesystem</li><li>Debian package for a Python project</li><li>Gitlab, Gitlab-CI and Docker Hub</li><li>Gitlab Webhook receiver for deployment</li></ol><p>Obviously this is <strong>a lot</strong>. So be patient while I write this down.</p><h3 id="digital&#95;ocean">Digital Ocean</h3><p>I chose <a href='https://m.do.co/c/dd5d931d13ce'>Digital Ocean (referral)</a> for this. There are no particular reasons for it, except a datacenter in Frankfurt, Germany and their great support for APIs. Nothing you wouldn't get at Amazon but maybe a little less <em>enterpsisy</em> &ndash; whatever that means.</p><h3 id="gitlab">Gitlab</h3><p>Github would be the obvious choice. But budget is small and I need a private repository. Gitlab-CI is integrated directly so I wouldn't need to pay extra for continuous integration. Also Gitlab-CI features build artifacts, which will be the Debian package I then only need to download.</p><h3 id="docker&#95;you&#95;say">Docker you say</h3><p>Another possibility for deployment would be to run everything inside Docker containers. Only for reasons as running out of time I chose not to do this now. It would mean to run everything in containers beginning from Nginx and Varnish down to the databases. Nothing too spectacular but then again I already have the necessary Ansible roles for all components and you shouldn't run Docker in production anyways. At least that is what the Internet tells me. Something like Kubernetes or Docker Swarm would certainly be too much for this.</p><h3 id="debian&#95;vm,&#95;security&#95;and&#95;common&#95;packages">Debian VM, security and common packages</h3><p>Debian is my default solution for running a server. Tons of resources, battle tested and I've been using Debian and/or Ubuntu for more than ten years now. There are however a few things one needs to do in order to secure a server.</p><h4 id="firewall">Firewall</h4><p>I used to write my IPTables rules by hand, nowadays the <a href='https://launchpad.net/ufw'>UFW (uncomplicated firewall)</a> does a decent job at creating these rules for you in a pretty easy manner. The base setup usually involves disabling all incoming traffic and then only allow the ports you care about:</p><pre><code>$ ufw default deny incoming</code></pre><p>You can even add simple connection rate limiting. Basically this will track connection attempts and if there are more than 6 attempts in the last 30 seconds the connecting IP is automatically banned:</p><pre><code>$ ufw limit ssh/tcp</code></pre><p>Enable the firewall with:</p><pre><code>$ ufw enable</code></pre><h4 id="fail2ban">Fail2ban</h4><p>Now that we have a rate-limiting firewall the next step is to add <a href='http://www.fail2ban.org/'>fail2ban</a>. Rate limiting is good but you do see many bots that try to guess passwords that are not doing this trying to max-out your bandwidth. This is what fail2ban is for.</p><p>It is a simple Python daemon that tails through logfiles and searches for regular expressions. In the SSHD case this might be failed login attempts in <code>/var/log/auth.log</code>, for NGINX you might find users trying all possible URLs for attacking a Wordpress site, e.g. The default installation comes with many predefined rules that you can enable in <code>/etc/fail2ban/jail.local</code>.</p><h4 id="secure&#95;sshd">Secure SSHD</h4><p>SSH is already pretty secure but you should follow some additional rules. First we declare the allowed key exchange algorithms, ciphers and macs that the daemon should use in <code>/etc/ssh/sshd&#95;config</code>. Then you really don't want <strong>root</strong> to be able to login via SSH and to be really safe we only want to use key-based authentication and disable passwords:</p><pre><code>KexAlgorithms diffie-hellman-group-exchange-sha256
Ciphers aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512,hmac-sha2-256,hmac-ripemd160
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication no</code></pre><h4 id="rootkithunter">RootkitHunter</h4><p>The final barrier is a locally running root kit hunter. Of course you do your best to not allow anyone gain access to your system but you can never be sure. The <a href='http://rkhunter.sourceforge.net/'>RootkitHunter</a> is a simple package that scans for known root kits. You can weekly update the database and have a cron job running once a day to scan your system:</p><pre><code>$ rkhunter --update
$ rkhunter --cron-job</code></pre><h4 id="common&#95;packages">Common packages</h4><p>Obviously YMMV at this point but my list of common packages I always install contains:</p><pre><code>$ apt-get install apt-transport-https debian-goodies git htop iftop iotop \\
    atop python-software-properties sudo unattended-upgrades</code></pre><p>This is the basic setup of a new VM. Two of them will be used for our production system. The next part will add corosync and pacemaker to both systems in order to automatically set the floating IP to one of the VMs.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/digitalocean.html">digitalocean</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2016-06-18-whatsapp.html">&laquo; WhatsApp or not</a>
        
        
        <a class="right" href="/posts/2016-02-01-varnish-all-the-things.html">Varnish all the things &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>Links</h3>
                <ul id="links">
                    <li><a href="http://twitter.com/truemped"><i class="fa fa-twitter"></i>&nbsp;@truemped</a></li>
                    <li><a href="http://github.com/truemped"><i class="fa fa-github"></i>&nbsp;truemped</a></li>
                    
                </ul>
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/posts/2016-06-18-whatsapp.html">WhatsApp or not</a></li>
                        
                        <li><a href="/posts/2016-06-07-failover-continuous-deployment.html">Continuous delivery with automatic failover</a></li>
                        
                        <li><a href="/posts/2016-02-01-varnish-all-the-things.html">Varnish all the things</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags-output/privacy.html">privacy</a></li>
                        
                        <li><a href="/tags-output/whatsapp.html">whatsapp</a></li>
                        
                        <li><a href="/tags-output/digitalocean.html">digitalocean</a></li>
                        
                        <li><a href="/tags-output/varnish.html">varnish</a></li>
                        
                        <li><a href="/tags-output/caching.html">caching</a></li>
                        
                        <li><a href="/tags-output/infrastructure.html">infrastructure</a></li>
                        
                        <li><a href="/tags-output/dsl.html">dsl</a></li>
                        
                        <li><a href="/tags-output/clojure.html">clojure</a></li>
                        
                        <li><a href="/tags-output/elasticsearch.html">elasticsearch</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2017 Daniel Truemper
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64224815-1', 'auto');
  ga('send', 'pageview');
</script>

 <link rel="stylesheet" type="text/css" href=nil>
<script>
window.klipse_settings = null;
</script>
<script src=nil></script> 

</body>
</html>
